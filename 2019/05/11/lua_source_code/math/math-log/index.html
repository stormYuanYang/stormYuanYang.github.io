<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>math_log</title><meta name="generator" content="Hexo 6.0.0"></head><body>　　<div class="inner"><h2>math_log</h2><h1 id="math-log简介"><a href="#math-log简介" class="headerlink" title="math_log简介"></a>math_log简介</h1><p><strong>math_log</strong>是lua库函数<strong>math.log</strong>的具体实现；一般而言，<strong>math_log</strong>接受两个参数，将这两个参数命名为x和base，math_log的目的是求x以base为底的对数。<strong>math_log</strong>的声明如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">math_log</span> <span class="params">(lua_State *L)</span>;</span><br></pre></td></tr></table></figure>

<p>使用lua方法<strong>math.log</strong>，需要调用者自己保证参数的合法性（一般规律：在lua中，一个方法需要的是数值，一般可以传入可以转换成数值的字符串，lua会在内部尝试转换）。</p>
<hr>
<h1 id="math-log实现"><a href="#math-log实现" class="headerlink" title="math_log实现"></a>math_log实现</h1><p><strong>math_log</strong>的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">math_log</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    lua_Number x = luaL_checknumber(L, <span class="number">1</span>);</span><br><span class="line">    lua_Number res;</span><br><span class="line">    <span class="keyword">if</span> (lua_isnoneornil(L, <span class="number">2</span>))</span><br><span class="line">        res = l_mathop(<span class="built_in">log</span>)(x);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        lua_Number base = luaL_checknumber(L, <span class="number">2</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(LUA_USE_C89)</span></span><br><span class="line">        <span class="keyword">if</span> (base == l_mathop(<span class="number">2.0</span>))</span><br><span class="line">            res = l_mathop(log2)(x); </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                <span class="keyword">if</span> (base == l_mathop(<span class="number">10.0</span>))</span><br><span class="line">                    res = l_mathop(<span class="built_in">log10</span>)(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    res = l_mathop(<span class="built_in">log</span>)(x)/l_mathop(<span class="built_in">log</span>)(base);</span><br><span class="line">    &#125;</span><br><span class="line">    lua_pushnumber(L, res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>math_log</strong>先获取第一个参数<strong>x</strong>，然后判断第二个参数<strong>base</strong>是否存在、是否为nil。 如果第二个参数<strong>base</strong>不存在或者是nil，则直接调用C标准库函数<strong>log</strong>（此函数的目的和C标准库函数<strong>exp</strong>的目的是相反的，<strong>exp</strong>求以<strong>e</strong>为底的指数）求<strong>x</strong>以科学常数<strong>e</strong>为底的对数；然后将结果入栈，然后函数返回。 如果第二个参数存在，则执行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        lua_Number base = luaL_checknumber(L, <span class="number">2</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(LUA_USE_C89)</span></span><br><span class="line">        <span class="keyword">if</span> (base == l_mathop(<span class="number">2.0</span>))</span><br><span class="line">            res = l_mathop(log2)(x); </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                <span class="keyword">if</span> (base == l_mathop(<span class="number">10.0</span>))</span><br><span class="line">                    res = l_mathop(<span class="built_in">log10</span>)(x);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    res = l_mathop(<span class="built_in">log</span>)(x)/l_mathop(<span class="built_in">log</span>)(base);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>首先获取第二个参数的值并赋值给<strong>base</strong>；注意这里有一个宏判断<code>#if !defined(LUA_USE_C89)</code>，其目的是保持兼容：采用<strong>C89</strong>标准编译lua时，无法使用C标准库函数<strong>log2</strong>的，因为<strong>log2</strong>直到在1993年才被加入标准库。如果不是采用<strong>C89</strong>标准编译lua，则可以使用<strong>log2</strong>，这样直接求以2为底的对数，效率要高一些。当base不等与2.0时，执行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (base == l_mathop(<span class="number">10.0</span>))</span><br><span class="line">    res = l_mathop(<span class="built_in">log10</span>)(x);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    res = l_mathop(<span class="built_in">log</span>)(x)/l_mathop(<span class="built_in">log</span>)(base);</span><br></pre></td></tr></table></figure>

<p>这里首先判断一下base是不是等于10；如果base等于10，则直接调用C标准库函数<strong>log10</strong>求x以10为底的对数；否则，根据数学公式（其中a、e均是常数）： $$ log_{a}x &#x3D; \frac{log_{e}x}{log_{e}a} $$ 可以通过先求得<strong>x</strong>以<strong>e</strong>为底的对数，再求得<strong>base</strong>以<strong>e</strong>为底的对数，前者除以后者就得到<strong>x</strong>以<strong>base</strong>为底的对数。</p>
<hr>
<h1 id="一些说明"><a href="#一些说明" class="headerlink" title="一些说明"></a>一些说明</h1><ol>
<li>我们称以<strong>10</strong>为底的对数叫做<strong>常用对数</strong>(common logarithm)；</li>
<li>称以无理数<strong>e</strong>（e&#x3D;2.71828…）为底的对数称为<strong>自然对数</strong>(natural logarithm)；</li>
<li><strong>e</strong>是一个无理数(<strong>e</strong>=2.71828…)，我们常常称其为<strong>科学常数</strong>；</li>
<li><strong>0</strong>是没有对数的；</li>
<li>在实数范围内，负数没有对数；在虚数范围内，负数有对数。</li>
</ol>
<p><span></span><a href="/">返回首页</a><span></span></p></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>
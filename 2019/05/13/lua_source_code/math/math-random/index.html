<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>math_random</title><meta name="generator" content="Hexo 6.0.0"></head><body>　　<div class="inner"><h2>math_random</h2><h1 id="math-random简介"><a href="#math-random简介" class="headerlink" title="math_random简介"></a>math_random简介</h1><p><strong>math_random</strong>是lua库函数<strong>math.random</strong>的具体实现。<strong>math_random</strong>的目的是获取一个伪随机数。<strong>math_random</strong>允许你通过传入的参数来控制产生的随机数的范围。<strong>math_random</strong>的声明如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">math_random</span> <span class="params">(lua_State *L)</span>;</span><br></pre></td></tr></table></figure>

<h1 id="math-random实现"><a href="#math-random实现" class="headerlink" title="math_random实现"></a>math_random实现</h1><p><strong>math_random</strong>的实现源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">math_random</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    lua_Integer low, up;</span><br><span class="line">    <span class="type">double</span> r = (<span class="type">double</span>)l_rand() * (<span class="number">1.0</span> / ((<span class="type">double</span>)L_RANDMAX + <span class="number">1.0</span>));</span><br><span class="line">    <span class="keyword">switch</span> (lua_gettop(L)) &#123;  <span class="comment">/* check number of arguments */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: &#123;  <span class="comment">/* no arguments */</span></span><br><span class="line">                    lua_pushnumber(L, (lua_Number)r);  <span class="comment">/* Number between 0 and 1 */</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: &#123;  <span class="comment">/* only upper limit */</span></span><br><span class="line">                    low = <span class="number">1</span>;</span><br><span class="line">                    up = luaL_checkinteger(L, <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: &#123;  <span class="comment">/* lower and upper limits */</span></span><br><span class="line">                    low = luaL_checkinteger(L, <span class="number">1</span>);</span><br><span class="line">                    up = luaL_checkinteger(L, <span class="number">2</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;wrong number of arguments&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* random integer in the interval [low, up] */</span></span><br><span class="line">    luaL_argcheck(L, low &lt;= up, <span class="number">1</span>, <span class="string">&quot;interval is empty&quot;</span>);</span><br><span class="line">    luaL_argcheck(L, low &gt;= <span class="number">0</span>  up &lt;= LUA_MAXINTEGER + low, <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;interval too large&quot;</span>);</span><br><span class="line">    r *= (<span class="type">double</span>)(up - low) + <span class="number">1.0</span>;</span><br><span class="line">    lua_pushinteger(L, (lua_Integer)r + low);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在分析<strong>math_random</strong>的实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> r = (<span class="type">double</span>)l_rand() * (<span class="number">1.0</span> / ((<span class="type">double</span>)L_RANDMAX + <span class="number">1.0</span>));</span><br></pre></td></tr></table></figure>

<p><strong>math_random</strong>直接通过<strong>l_rand</strong>先求得一个随机数，然后将其缩小到$[0,1)$之间。注意，这里使用<strong>double</strong>类型来表示随机数，而不是<strong>lua_Number：</strong>考虑到兼容性，<strong>lua_Number</strong>可能是<strong>float</strong>类型；当<strong>lua_Number</strong>是<strong>float</strong>类型时，缩小随机数可能会丢失精度；缩小随机数时应该竟可能地保留精度，这样才能体现更好的随机性。这里(double)L_RANDMAX加1的目的是，保证缩小后的随机数<strong>r</strong>小于1。 接下来是一个<strong>switch</strong>语句，对调用者传入的参数做判断，并根据参数的数量和值确定求取随机数范围的上界<strong>up</strong>和下界<strong>low</strong>：</p>
<ul>
<li>不传入任何参数调用lua函数<strong>math.random</strong>；此为默认情况，随机数范围在$[0,1)$之间；直接将随机数入栈即可；</li>
<li>只传入一个参数调用lua函数<strong>math.random</strong>；此时，<strong>math_random</strong>认为传入的是上界，随机数范围在$[1,up]$内；</li>
<li>传入两个参数调用lua函数<strong>math.random</strong>；此时，下界和上界都由调用者提供，随机数范围在$[low,up]$内。</li>
</ul>
<p>接下来执行参数检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">luaL_argcheck(L, low &lt;= up, <span class="number">1</span>, <span class="string">&quot;interval is empty&quot;</span>);</span><br><span class="line">luaL_argcheck(L, low &gt;= <span class="number">0</span>  up &lt;= LUA_MAXINTEGER + low, <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;interval too large&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>需要调用者保证：</p>
<ul>
<li><strong>low</strong>小于等于<strong>up；</strong></li>
<li>随机数范围要在合理范围内：<strong>随机数范围</strong>的大小（也可称之为长度）只能在**[0,LUA_MAXINTEGER]<strong>内;随机数本身只能在</strong>[low,LUA_MAXINTEGER+low]**之间。</li>
</ul>
<p>然后执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r *= (<span class="type">double</span>)(up - low) + <span class="number">1.0</span>;</span><br></pre></td></tr></table></figure>

<p>这里加1.0的目的是保证<strong>r</strong>在$[0,up-(low-1)]$内; 然后将<strong>r</strong>移动到$[low,high]$中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua_pushinteger(L, (lua_Integer)r + low);</span><br></pre></td></tr></table></figure>

<p>将<strong>r</strong>移动到$[low,high]$范围内，得到最终结果，然后将其入栈。</p>
<p><span></span><a href="/">返回首页</a><span></span></p></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>
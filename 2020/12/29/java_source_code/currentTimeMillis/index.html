<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>深入理解System.currentTimeMillis()</title><meta name="generator" content="Hexo 6.0.0"></head><body>　　<div class="inner"><h2>深入理解System.currentTimeMillis()</h2><h2 id="currentTimeMillis"><a href="#currentTimeMillis" class="headerlink" title="currentTimeMillis"></a>currentTimeMillis</h2><p>当我们在Java需要获取当系统当前时间时,想到的第一个函数肯定是System.currentTimeMills(),这个函数返回从1970年1月1日凌晨0点(准确地说是1970-01-01 00:00:00 UTC)到当前时刻所走过的时间,正如其名字所表示,这个函数返回的时间以毫秒为单位.</p>
<p><strong>System.currentTimeMills()的返回值取决于Java运行时系统的本地时区!千万不要忘记这一点!</strong><br>同一时刻,在英国和中国的两个人同时用System.currentTimeMills()获取当前系统时间,其返回值不是一样的,除非手动将操作系统的时区设置成同一个时区(英国使用UTC+0,而中国使用UTC+8,中国比英国快8个小时).</p>
<p>System.currentTimeMills()依赖于OS的实现,所以这个函数并不是由java代码实现,正如其声明:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the current time in milliseconds.  Note that</span></span><br><span class="line"><span class="comment">     * while the unit of time of the return value is a millisecond,</span></span><br><span class="line"><span class="comment">     * the granularity of the value depends on the underlying</span></span><br><span class="line"><span class="comment">     * operating system and may be larger.  For example, many</span></span><br><span class="line"><span class="comment">     * operating systems measure time in units of tens of</span></span><br><span class="line"><span class="comment">     * milliseconds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; See the description of the class &#123;<span class="doctag">@code</span> Date&#125; for</span></span><br><span class="line"><span class="comment">     * a discussion of slight discrepancies that may arise between</span></span><br><span class="line"><span class="comment">     * &quot;computer time&quot; and coordinated universal time (UTC).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  the difference, measured in milliseconds, between</span></span><br><span class="line"><span class="comment">     *          the current time and midnight, January 1, 1970 UTC.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span>     java.util.Date</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HotSpotIntrinsicCandidate</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">currentTimeMillis</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>Java用native关键词表示这个函数由本地函数实现.那就让我们看看System.currentTimeMills到底是如何实现的.接下来查看Windows和Linux平台实现(OS类别实在太多,你有兴趣可以查看其他OS平台下的实现).</p>
<p>首先,Java中的System类里的native方法,对应到Java的实现源码就在System.c中:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Only register the performance-critical methods */</span><span class="type">static</span> JNINativeMethod methods[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;currentTimeMillis&quot;</span>, <span class="string">&quot;()J&quot;</span>,              (<span class="type">void</span> *)&amp;JVM_CurrentTimeMillis&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;nanoTime&quot;</span>,          <span class="string">&quot;()J&quot;</span>,              (<span class="type">void</span> *)&amp;JVM_NanoTime&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;arraycopy&quot;</span>,     <span class="string">&quot;(&quot;</span> OBJ <span class="string">&quot;I&quot;</span> OBJ <span class="string">&quot;II)V&quot;</span>, (<span class="type">void</span> *)&amp;JVM_ArrayCopy&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里给出了java中的函数名字,和对应的c函数指针,通过c函数指针JVM_CurrentTimeMillis,找到对应实现:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JVM_LEAF</span>(jlong, <span class="built_in">JVM_CurrentTimeMillis</span>(JNIEnv *env, jclass ignored))</span><br><span class="line">  <span class="built_in">JVMWrapper</span>(<span class="string">&quot;JVM_CurrentTimeMillis&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> os::<span class="built_in">javaTimeMillis</span>();</span><br><span class="line">JVM_END</span><br></pre></td></tr></table></figure>

<p>由上述源码可知,调用各个OS的<code>os::javaTimeMillis()</code>来获取当前时间.</p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Linux的javaTimeMillis()实现:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jlong <span class="title">os::javaTimeMillis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  timeval time;</span><br><span class="line">  <span class="type">int</span> status = <span class="built_in">gettimeofday</span>(&amp;time, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">assert</span>(status != <span class="number">-1</span>, <span class="string">&quot;linux error&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">jlong</span>(time.tv_sec) * <span class="number">1000</span>  +  <span class="built_in">jlong</span>(time.tv_usec / <span class="number">1000</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>由第3行代码可知,在Linux平台下Java获取系统当前时间实际调用的就是函数<code>gettimeofday()</code>,返回的结果放入<code>time</code>中.第5行代码通过单位的换算,返回以毫秒为单位的时间.</p>
<p>gettimeofday返回的时间以秒和微秒为单位,但是这并不意味着其时间的准确度就是1个微秒,其准确度取决于你使用的机器(关于gettimeofday详细介绍可以戳<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/gettimeofday.2.html">这里</a>,这里就不再过多说明).</p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows的javaTimeMillis()实现:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jlong <span class="title">os::javaTimeMillis</span><span class="params">()</span> </span>&#123;           </span><br><span class="line">  <span class="keyword">if</span> (UseFakeTimers) &#123;</span><br><span class="line">    <span class="keyword">return</span> fake_time++;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    FILETIME wt;</span><br><span class="line">    <span class="built_in">GetSystemTimeAsFileTime</span>(&amp;wt);<span class="comment">// Windows平台提供的获取当前时间的函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">windows_to_java_time</span>(wt);<span class="comment">// 转换成毫秒,并返回</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jlong <span class="title">windows_to_java_time</span><span class="params">(FILETIME wt)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 根据wt存放的时间信息转换成jlong类型.</span></span><br><span class="line">  jlong a = <span class="built_in">jlong_from</span>(wt.dwHighDateTime, wt.dwLowDateTime);</span><br><span class="line">  <span class="comment">// 这里有两个疑问:</span></span><br><span class="line">  <span class="comment">// 1.为什么要减去一个偏移量offset()?</span></span><br><span class="line">  <span class="comment">// 答:因为FILETIME结构的wt代表从1601年1月1日开始到当前的时间的一个数字(时间以100纳秒为间隔得到:总时间(以纳秒为单位)除以100就得到这个数字),而Java需要的是计算从1970年1月1日开始到现在的毫秒数;那么就需要减去这个差值.</span></span><br><span class="line">  <span class="comment">// 2.减去偏移量之后,为什么还要除以10000(一万)?</span></span><br><span class="line">  <span class="comment">// 答:因为a-offset()的结果是以100纳秒为基本单位的一个数字,需要转换成毫秒,就需要除以10000.</span></span><br><span class="line">  <span class="comment">// 1秒=1000毫秒;</span></span><br><span class="line">  <span class="comment">// 1毫秒=1000微秒;</span></span><br><span class="line">  <span class="comment">// 1微秒=1000纳秒.</span></span><br><span class="line">  <span class="keyword">return</span> (a - <span class="built_in">offset</span>()) / <span class="number">10000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第2行到第3行的代码可以先忽略,这部分逻辑是debug用的;关键在于第6行的<code>GetSystemTimeAsFileTime()</code>和第7行的<code>windows_to_java_time()</code>函数调用.同样的要注意,<code>GetSystemTimeAsFileTime()</code>返回的时间信息虽然以100个纳秒为间隔,但是这并不意味着其准确度就是100纳秒,这取决于你的Windows系统.</p>
<h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h2><p>1.以上所说java的版本均为java11,实现java本身的源码来自OpenJdk 11.</p>
<p>2.OS是operater system,即操作系统的缩写.</p>
<p>3.UTC是Universal Time Coordinated的缩写,即协调世界时.比如北京时间和UTC +0的时差为+8,也就是UTC+8,俗称东八区;但是因为祖国幅员辽阔,横跨多个时区,为了保证时间的准确统一,祖国其他地方统一使用北京时间授时.</p>
<p>4.System.c位于Java源码目录下的java.base&#x2F;share&#x2F;native&#x2F;libjava&#x2F;System.c.</p>
<p>5.探究java方法的实现,目的是理解其原理做到知其然知其所以然,但并不会陷入过多的实现细节,比如c&#x2F;C++里的宏定义等.</p>
<p><span></span><a href="/">返回首页</a><span></span></p></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>
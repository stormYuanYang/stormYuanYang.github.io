<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>æ·±å…¥ç†è§£System.nanoTime()</title><meta name="generator" content="Hexo 6.0.0"></head><body>ã€€ã€€<div class="inner"><h2>æ·±å…¥ç†è§£System.nanoTime()</h2><h2 id="nanoTime"><a href="#nanoTime" class="headerlink" title="nanoTime"></a>nanoTime</h2><p>å‰å‡ å¤©åˆ†æäº†<code>System.currentTimeMillis()</code>çš„å®ç°ï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹å’Œå®ƒæ¯”è¾ƒç›¸ä¼¼ä½†åˆä¸åŒçš„<code>System.nanoTime()</code>ã€‚<code>System.nanoTime()</code>çš„ç›®çš„æ˜¯ç”¨äº<strong>æµ‹é‡æ—¶é—´çš„å·®å€¼æˆ–è€…è¯´æ—¶é—´çš„æµé€</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">func</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">  func();</span><br><span class="line">  <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">  <span class="type">long</span> <span class="variable">diff</span> <span class="operator">=</span> end - begin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œ<code>System.nanoTime()</code>è¿”å›çš„å¹¶ä¸æ˜¯å½“å‰æ—¶é—´ï¼ˆå’Œ<code>System.currentTimeMillis()</code>çš„å«ä¹‰ä¸ä¸€æ ·ï¼‰ï¼Œè€Œæ˜¯<strong>å½“å‰æ—¶åˆ»</strong>åˆ°<strong>ä¸€ä¸ªå›ºå®šä½†æ˜¯å¯ä»¥ä»»æ„çš„æ—¶é—´ç‚¹</strong>çš„å·®å€¼ï¼ˆæ˜¯ä¸æ˜¯æœ‰ç‚¹ç»•ğŸ˜œï¼Œä¸ºäº†è¡¨è¿°çš„ä¸¥è°¨åªèƒ½å¦‚æ­¤)ï¼Œä¹Ÿå°±æ˜¯è¯´è¿”å›å€¼å¯èƒ½æ˜¯æ­£æ•°ä¹Ÿå¯èƒ½æ˜¯è´Ÿæ•°ï¼Œä½†å®é™…ä¸­çš„å®ç°ä¸€èˆ¬æ˜¯å½“å‰æ—¶åˆ»åˆ°è¿‡å»çš„æŸä¸ªæ—¶é—´ç‚¹ï¼ˆæ¯”å¦‚Linuxç”¨çš„ç³»ç»Ÿå¯åŠ¨æ—¶é—´ç‚¹ï¼‰çš„å·®å€¼ï¼›æ‰€ä»¥åªèƒ½ç”¨è‹¥å¹²<code>System.nanoTime()</code>è°ƒç”¨è·å–å…¶å·®å€¼åšä¸€äº›åˆ¤æ–­æˆ–è¿ç®—ï¼Œæ¢è€Œè¨€ä¹‹ä¸€æ¬¡è°ƒç”¨åŸºæœ¬æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼›è€Œä¸”ä¸åŒJavaè™šæ‹Ÿæœºè°ƒç”¨<code>System.nanoTime()</code>ç”¨çš„èµ·å§‹ç‚¹å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒè™šæ‹Ÿæœºä¹‹é—´ä¸èƒ½ç”¨å…¶å€¼æ¥åˆ¤æ–­æ—¶é—´æµé€ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ï¼Œ<code>System.nanoTime()</code>åœ¨Javaä¸­çš„å£°æ˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the current value of the running Java Virtual Machine&#x27;s</span></span><br><span class="line"><span class="comment">     * high-resolution time source, in nanoseconds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method can only be used to measure elapsed time and is</span></span><br><span class="line"><span class="comment">     * not related to any other notion of system or wall-clock time.</span></span><br><span class="line"><span class="comment">     * The value returned represents nanoseconds since some fixed but</span></span><br><span class="line"><span class="comment">     * arbitrary &lt;i&gt;origin&lt;/i&gt; time (perhaps in the future, so values</span></span><br><span class="line"><span class="comment">     * may be negative).  The same origin is used by all invocations of</span></span><br><span class="line"><span class="comment">     * this method in an instance of a Java virtual machine; other</span></span><br><span class="line"><span class="comment">     * virtual machine instances are likely to use a different origin.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This method provides nanosecond precision, but not necessarily</span></span><br><span class="line"><span class="comment">     * nanosecond resolution (that is, how frequently the value changes)</span></span><br><span class="line"><span class="comment">     * - no guarantees are made except that the resolution is at least as</span></span><br><span class="line"><span class="comment">     * good as that of &#123;<span class="doctag">@link</span> #currentTimeMillis()&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Differences in successive calls that span greater than</span></span><br><span class="line"><span class="comment">     * approximately 292 years (2&lt;sup&gt;63&lt;/sup&gt; nanoseconds) will not</span></span><br><span class="line"><span class="comment">     * correctly compute elapsed time due to numerical overflow.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The values returned by this method become meaningful only when</span></span><br><span class="line"><span class="comment">     * the difference between two such values, obtained within the same</span></span><br><span class="line"><span class="comment">     * instance of a Java virtual machine, is computed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;For example, to measure how long some code takes to execute:</span></span><br><span class="line"><span class="comment">     * &lt;pre&gt; &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">     * long startTime = System.nanoTime();</span></span><br><span class="line"><span class="comment">     * // ... the code being measured ...</span></span><br><span class="line"><span class="comment">     * long elapsedNanos = System.nanoTime() - startTime;&#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;To compare elapsed time against a timeout, use &lt;pre&gt; &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">     * if (System.nanoTime() - startTime &gt;= timeoutNanos) ...&#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     * instead of &lt;pre&gt; &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">     * if (System.nanoTime() &gt;= startTime + timeoutNanos) ...&#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">     * because of the possibility of numerical overflow.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the current value of the running Java Virtual Machine&#x27;s</span></span><br><span class="line"><span class="comment">     *         high-resolution time source, in nanoseconds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HotSpotIntrinsicCandidate</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">nanoTime</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>ç”±ä¸Šè¿°å£°æ˜å’Œæ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒJavaæä¾›çš„<code>System.nanoTime()</code>è¿”å›ä»¥çº³ç§’ä¸ºå•ä½çš„é«˜ç²¾åº¦æ—¶é—´ï¼Œä¸è¿‡è¿™å¹¶ä¸æ„å‘³ç€å…¶å‡†ç¡®åº¦å°±æ˜¯1çº³ç§’ã€‚ç‰¹åˆ«æ³¨æ„è¿™è¿™é‡Œï¼š</p>
<blockquote><p>This method can only be used to measure elapsed time and is not related to any other notion of system or wall-clock time.</p>
<footer><strong>Java</strong><cite>System.nanoTime()</cite></footer></blockquote>
<p>å’Œ<code>System.currentTimeMillis()</code>ä¸€æ ·ï¼Œ<code>System.nanoTime()</code>åœ¨è¿™é‡Œåªæœ‰å£°æ˜ï¼Œè€Œæ²¡æœ‰å…·ä½“å®ç°ï¼Œå…¶å®ç°ç”±æ›´åº•å±‚çš„C&#x2F;C++å®Œæˆã€‚<code>System.nanoTime()</code>å¯¹åº”åˆ°å®ç°æºç åœ¨System.cä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Only register the performance-critical methods */</span><span class="type">static</span> JNINativeMethod methods[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;currentTimeMillis&quot;</span>, <span class="string">&quot;()J&quot;</span>,              (<span class="type">void</span> *)&amp;JVM_CurrentTimeMillis&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;nanoTime&quot;</span>,          <span class="string">&quot;()J&quot;</span>,              (<span class="type">void</span> *)&amp;JVM_NanoTime&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;arraycopy&quot;</span>,     <span class="string">&quot;(&quot;</span> OBJ <span class="string">&quot;I&quot;</span> OBJ <span class="string">&quot;II)V&quot;</span>, (<span class="type">void</span> *)&amp;JVM_ArrayCopy&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡å‡½æ•°æŒ‡é’ˆJVM_NanoTimeæ‰¾åˆ°å…¶å¯¹åº”å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JVM_LEAF</span>(jlong, <span class="built_in">JVM_NanoTime</span>(JNIEnv *env, jclass ignored))</span><br><span class="line">  <span class="built_in">JVMWrapper</span>(<span class="string">&quot;JVM_NanoTime&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> os::<span class="built_in">javaTimeNanos</span>();      </span><br><span class="line">JVM_END</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼ŒJavaå®ç°<code>System.nanoTime()</code>è¿˜æ˜¯ä¾èµ–ä¸åŒOSçš„å®ç°ï¼›æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±çœ‹çœ‹Linuxå’ŒWindowå¹³å°ä¸‹çš„å®ç°ã€‚</p>
<h3 id="nanoTimeåœ¨Linuxä¸‹çš„å®ç°"><a href="#nanoTimeåœ¨Linuxä¸‹çš„å®ç°" class="headerlink" title="nanoTimeåœ¨Linuxä¸‹çš„å®ç°"></a>nanoTimeåœ¨Linuxä¸‹çš„å®ç°</h3><p>æˆ‘ä»¬åœ¨os_linux.cppæ–‡ä»¶ä¸­æ‰¾åˆ°nanoTimeçš„å®ç°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jlong <span class="title">os::javaTimeNanos</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å…ˆæ£€æŸ¥å½“å‰çš„OSæ˜¯å¦æ”¯æŒmonotonic clock</span></span><br><span class="line">  <span class="keyword">if</span> (os::<span class="built_in">supports_monotonic_clock</span>()) &#123;</span><br><span class="line">    <span class="comment">// æ”¯æŒmonotonic clock</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timespec</span> tp;</span><br><span class="line">    <span class="comment">// è°ƒç”¨Linuxå¹³å°ä¸‹çš„clock_gettime()è·å–äº‹ä»¶ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œçš„ä¼ å…¥ç±»å‹æ˜¯CLOCK_MONOTONIC</span></span><br><span class="line">    <span class="type">int</span> status = Linux::<span class="built_in">clock_gettime</span>(CLOCK_MONOTONIC, &amp;tp);</span><br><span class="line">    <span class="built_in">assert</span>(status == <span class="number">0</span>, <span class="string">&quot;gettime error&quot;</span>);</span><br><span class="line">    <span class="comment">// å¯¹clock_gettime()è¿”å›çš„æ—¶é—´ä¿¡æ¯ï¼Œè¿›è¡Œå•ä½è½¬æ¢åè¿”å›</span></span><br><span class="line">    jlong result = <span class="built_in">jlong</span>(tp.tv_sec) * (<span class="number">1000</span> * <span class="number">1000</span> * <span class="number">1000</span>) + <span class="built_in">jlong</span>(tp.tv_nsec);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸æ”¯æŒmonotonic clockï¼Œåˆ™è°ƒç”¨gettimeofday()è·å–æ—¶é—´ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// è¿™éƒ¨åˆ†ä»£ç å’ŒSystem.currentTimeMillis()åœ¨Linuxå¹³å°å®ç°</span></span><br><span class="line">    <span class="comment">// å®Œå…¨ä¸€æ ·</span></span><br><span class="line">    timeval time;</span><br><span class="line">    <span class="type">int</span> status = <span class="built_in">gettimeofday</span>(&amp;time, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">assert</span>(status != <span class="number">-1</span>, <span class="string">&quot;linux error&quot;</span>);</span><br><span class="line">    jlong usecs = <span class="built_in">jlong</span>(time.tv_sec) * (<span class="number">1000</span> * <span class="number">1000</span>) + <span class="built_in">jlong</span>(time.tv_usec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1000</span> * usecs;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šè¿°ä»£ç å’Œæ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥å¯¹javaTimeNanos()æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œå…¶æœ¬èº«ä¹Ÿä¸å¤æ‚,å…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹å›¾:<img src="/2021/01/05/java_source_code/nanoTime/javaTimeNanos.png" class=""></p>
<p>å¦‚æœå½“å‰Linuxå¹¶ä¸æ”¯æŒmonotonic clock,System.nanoTime()å’ŒSystem.currentTimeMillis()å®é™…ä¸Šå°±æ˜¯ç­‰ä»·çš„,ä½†è¿™ç§æƒ…å†µç›®å‰ä¸€èˆ¬ä¸ä¼šå‡ºç°ï¼Œå¯èƒ½ä¼šå‡ºç°åœ¨ä¸€äº›éå¸¸å¤è€çš„Linuxç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å¦‚æœå½“å‰ç³»ç»Ÿä¸æ”¯æŒmonotonic clock,Javaä¹Ÿç»™å‡ºäº†è­¦å‘Šï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os_linux.cpp</span></span><br><span class="line"><span class="type">void</span> os::Linux::<span class="built_in">clock_init</span>() &#123;</span><br><span class="line">  <span class="comment">// we do dlopen&#x27;s in this particular order due to bug in linux</span></span><br><span class="line">  <span class="comment">// dynamical loader (see 6348968) leading to crash on exit</span></span><br><span class="line">  <span class="type">void</span>* handle = <span class="built_in">dlopen</span>(<span class="string">&quot;librt.so.1&quot;</span>, RTLD_LAZY);</span><br><span class="line">  <span class="keyword">if</span> (handle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    handle = <span class="built_in">dlopen</span>(<span class="string">&quot;librt.so&quot;</span>, RTLD_LAZY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (handle) &#123;</span><br><span class="line">    <span class="built_in">int</span> (*clock_getres_func)(<span class="type">clockid_t</span>, <span class="keyword">struct</span> timespec*) =</span><br><span class="line">           (<span class="built_in">int</span>(*)(<span class="type">clockid_t</span>, <span class="keyword">struct</span> timespec*))<span class="built_in">dlsym</span>(handle, <span class="string">&quot;clock_getres&quot;</span>);</span><br><span class="line">    <span class="built_in">int</span> (*clock_gettime_func)(<span class="type">clockid_t</span>, <span class="keyword">struct</span> timespec*) =</span><br><span class="line">           (<span class="built_in">int</span>(*)(<span class="type">clockid_t</span>, <span class="keyword">struct</span> timespec*))<span class="built_in">dlsym</span>(handle, <span class="string">&quot;clock_gettime&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (clock_getres_func &amp;&amp; clock_gettime_func) &#123;</span><br><span class="line">      <span class="comment">// See if monotonic clock is supported by the kernel. Note that some</span></span><br><span class="line">      <span class="comment">// early implementations simply return kernel jiffies (updated every</span></span><br><span class="line">      <span class="comment">// 1/100 or 1/1000 second). It would be bad to use such a low res clock</span></span><br><span class="line">      <span class="comment">// for nano time (though the monotonic property is still nice to have).</span></span><br><span class="line">      <span class="comment">// It&#x27;s fixed in newer kernels, however clock_getres() still returns</span></span><br><span class="line">      <span class="comment">// 1/HZ. We check if clock_getres() works, but will ignore its reported</span></span><br><span class="line">      <span class="comment">// resolution for now. Hopefully as people move to new kernels, this</span></span><br><span class="line">      <span class="comment">// won&#x27;t be a problem.</span></span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">timespec</span> res;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">timespec</span> tp;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">clock_getres_func</span> (CLOCK_MONOTONIC, &amp;res) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">          <span class="built_in">clock_gettime_func</span>(CLOCK_MONOTONIC, &amp;tp)  == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// yes, monotonic clock is supported</span></span><br><span class="line">        _clock_gettime = clock_gettime_func;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// close librt if there is no monotonic clock</span></span><br><span class="line">        <span class="built_in">dlclose</span>(handle);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">warning</span>(<span class="string">&quot;No monotonic clock was available - timed services may &quot;</span> \</span><br><span class="line">          <span class="string">&quot;be adversely affected if the time-of-day clock changes&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šæ£€æµ‹Linuxå†…æ ¸æ˜¯å¦æ”¯æŒ<code>clock_getres</code>å’Œ<code>clock_gettime</code>,å¦‚æœä¸æ”¯æŒ,Javaä¼šç»™å‡ºè­¦å‘Šï¼š</p>
<blockquote><p>No monotonic clock was available - timed services may be adversely affected if the time-of-day clock changes.</p>
<footer><strong>os_linux.cpp</strong><cite>lock_init()</cite></footer></blockquote>

<p>å…³äº<code>clock_getres</code>å’Œ<code>clock_gettime</code>çš„ä»‹ç»è¯·æˆ³<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/clock_gettime.2.html">è¿™é‡Œ</a>ï¼Œç‰¹åˆ«æ³¨æ„é‡Œé¢å…³äºæ—¶é—´ç±»å‹CLOCK_MONOTONICçš„æè¿°ï¼š</p>
<blockquote><p>A nonsettable system-wide clock that represents monotonic time sinceâ€”as described by POSIXâ€”â€œsome unspecified point in the pastâ€.  <strong>On Linux, that point corresponds to the number of seconds that the system has been running since it was booted.</strong></p>
<p>The CLOCK_MONOTONIC clock is not affected by discontinuous jumps in the system time (e.g., if the system administrator manually changes the clock), but is affected by the incremental adjustments performed by adjtime(3) and NTP.  This clock does not count time that the system is suspended.  All CLOCK_MONOTONIC variants guarantee that the time returned by consecutive calls will not go backwards, but successive calls mayâ€”depending on the architectureâ€”return identical (not-increased) time values.</p>
<footer><strong>Linux clock_gettime,</strong><cite><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/clock_gettime.2.html">man7.org/linux/man-pages/man2/clock_gettime.2.html</a></cite></footer></blockquote>

<p>ç”±ä¸Šè¿°å¯çŸ¥ï¼Œä»¥ç±»å‹ClOCK_MONOTONICè·å–æ—¶é—´ä¿¡æ¯æ—¶ï¼š</p>
<ul>
<li>åœ¨Linuxä¸‹å’Œç³»ç»Ÿçš„å¯åŠ¨æ—¶é—´ç‚¹ç›¸å…³ï¼›</li>
<li>æ‰‹åŠ¨ä¿®æ”¹æœ¬åœ°æ—¶é—´ï¼Œå¹¶ä¸ä¼šå½±å“clock_gettime()è·å–çš„clockï¼›ä½†æ˜¯ä¼šå—åˆ°adjtimeå’ŒNTPçš„å½±å“ï¼›</li>
<li>å¹¶ä¸ä¼šè®¡ç®—ç³»ç»Ÿæš‚åœçš„æ—¶é—´æµé€ã€‚</li>
</ul>
<h3 id="nanoTimeåœ¨Windowsä¸‹çš„å®ç°"><a href="#nanoTimeåœ¨Windowsä¸‹çš„å®ç°" class="headerlink" title="nanoTimeåœ¨Windowsä¸‹çš„å®ç°"></a>nanoTimeåœ¨Windowsä¸‹çš„å®ç°</h3><p>åœ¨os_windows.cppä¸­æ‰¾åˆ°javaTimeNanos()çš„å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jlong <span class="title">os::javaTimeNanos</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LARGE_INTEGER current_count;</span><br><span class="line">    <span class="comment">// Windowsæä¾›çš„å‡½æ•°ï¼šæŸ¥è¯¢å½“å‰çš„è®¡æ•°</span></span><br><span class="line">    <span class="built_in">QueryPerformanceCounter</span>(&amp;current_count);</span><br><span class="line">    <span class="type">double</span> current = <span class="built_in">as_long</span>(current_count);</span><br><span class="line">    <span class="comment">// è·å–é¢‘ç‡</span></span><br><span class="line">    <span class="type">double</span> freq = performance_frequency;</span><br><span class="line">    <span class="comment">// currenté™¤ä»¥freqæ‰æ˜¯å¯¹åº”çš„æ—¶é—´ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// å°†æ—¶é—´ä¿¡æ¯è½¬æ¢æˆçº³ç§’å•ä½</span></span><br><span class="line">    jlong time = (jlong)((current/freq) * NANOSECS_PER_SEC);</span><br><span class="line">    <span class="keyword">return</span> time;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±ä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬æ¨æµ‹Windowsè·å–é«˜ç²¾åº¦çš„æ—¶é—´ä¿¡æ¯æ˜¯é€šè¿‡ä¸€ä¸ªå•è°ƒé€’å¢çš„è®¡æ•°å™¨ï¼Œè®¡æ•°å™¨çš„å¢é•¿å°±æ„å‘³ç€æ—¶é—´çš„æµé€ï¼›é‚£ä¹ˆè®¡æ•°å™¨çš„å¢é•¿å¿…ç„¶æ˜¯æœ‰ä¸€ä¸ªé¢‘ç‡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šé•¿æ—¶é—´æ‰§è¡Œä¸€æ¬¡è®¡æ•°å™¨å¢é•¿æ“ä½œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os_windows.cpp</span></span><br><span class="line"><span class="type">static</span> jlong initial_performance_count;</span><br><span class="line"><span class="type">static</span> jlong performance_frequency;</span><br><span class="line"><span class="type">void</span> os::win32::<span class="built_in">initialize_performance_counter</span>() &#123;</span><br><span class="line">  LARGE_INTEGER count;</span><br><span class="line">  <span class="comment">// Windowsæä¾›çš„å‡½æ•°ï¼šæŸ¥è¯¢æ›´æ–°è®¡æ•°çš„é¢‘ç‡</span></span><br><span class="line">  <span class="built_in">QueryPerformanceFrequency</span>(&amp;count);</span><br><span class="line">  performance_frequency = <span class="built_in">as_long</span>(count);</span><br><span class="line">  <span class="comment">// æŸ¥è¯¢å½“å‰çš„è®¡æ•°</span></span><br><span class="line">  <span class="built_in">QueryPerformanceCounter</span>(&amp;count);</span><br><span class="line">  <span class="comment">// è®°å½•èµ·å§‹çš„è®¡æ•°</span></span><br><span class="line">  initial_performance_count = <span class="built_in">as_long</span>(count);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ç³»ç»Ÿä¿¡æ¯</span></span><br><span class="line"><span class="type">void</span> os::win32::<span class="built_in">initialize_system_info</span>() &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ã€‚ã€‚ã€‚ çœç•¥</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">initialize_performance_counter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°åˆå§‹åŒ–æ“ä½œï¼Œå°è¯äº†æˆ‘ä»¬çš„æ¨æµ‹ï¼›è¿™ä¹Ÿæ„å‘³ç€åœ¨Windowså¹³å°ä¸‹QueryPerformanceFrequency()è¿”å›çš„ä¿¡æ¯â€”â€”è¿™ä¸ªé¢‘ç‡å†³å®šäº†æˆ‘ä»¬è·å–æ—¶é—´çš„å‡†ç¡®åº¦ã€‚</p>
<p>Windowså…³äºQueryPerformanceFrequency()çš„è§£é‡Šï¼š</p>
<blockquote><p>Retrieves the frequency of the performance counter. <strong>The frequency of the performance counter is fixed at system boot and is consistent across all processors.</strong> Therefore, the frequency need only be queried upon application initialization, and the result can be cached.</p>
<footer><strong>Windows API,</strong><cite><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency">docs.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency</a></cite></footer></blockquote>

<p>Windowså…³äºQueryPerformanceCounter()çš„è§£é‡Šï¼š</p>
<blockquote><p>Retrieves the current value of the performance counter, which is a high resolution (&lt;1us) time stamp that can be used for time-interval measurements.</p>
<footer><strong>Windows API,</strong><cite><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter">docs.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter</a></cite></footer></blockquote>

<p>æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨Windowså¹³å°ä¸‹ï¼Œè¿™ä¸ªé«˜ç²¾åº¦æ—¶é—´ä¿¡æ¯åŒæ ·å’Œç³»ç»Ÿå¯åŠ¨æ—¶é—´ç›¸å…³ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡æ·±å…¥ç†è§£System.nanoTime()åœ¨Linuxå¹³å°å’ŒWindowså¹³å°çš„ä¸åŒå®ç°ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸è®ºæ˜¯Linuxè¿˜æ˜¯Windowséƒ½æ˜¯é€šè¿‡ç³»ç»Ÿå¯åŠ¨æ—¶é—´ç‚¹æ¥è·å–æˆ‘ä»¬éœ€è¦çš„é«˜ç²¾åº¦å•è°ƒé€’å¢çš„æ—¶é—´ä¿¡æ¯ã€‚é€šè¿‡System.nanoTime()æˆ‘ä»¬è·å–äº†ä»¥çº³ç§’ä¸ºå•ä½çš„é«˜ç²¾åº¦æ—¶é—´ä¿¡æ¯ï¼ˆè®°ä½ï¼Œå…¶å‡†ç¡®åº¦ä¸ä¸€å®šæ˜¯1çº³ç§’ï¼‰ï¼Œä½†åŒæ—¶æˆ‘ä»¬ä¹Ÿä¼šä»˜å‡ºæ›´å¤§çš„æ€§èƒ½ä»£ä»·ï¼ˆæ¯”èµ·System.currentTimeMillis()æ¥è¯´ï¼‰ã€‚æœ€åï¼Œä¹Ÿæœ‰å…¶ä»–æ–¹å¼è·å–ç²¾åº¦æ›´é«˜çš„æ—¶é—´ä¿¡æ¯ï¼ˆCPUæ—¶é’Ÿï¼‰ï¼Œå½“ç„¶æ€§èƒ½ä»£ä»·æ›´å¤§ï¼Œè¿™å°±å¯èƒ½éœ€è¦ä¾èµ–å…·ä½“æŸä¸ªå¹³å°çš„å®ç°äº†ï¼Œè¿™é‡Œåªå…³å¿ƒJavaæºç çš„å®ç°ï¼Œå°±ä¸ç»§ç»­æ·±å…¥æ¢è®¨äº†ã€‚</p>
<h2 id="å¤‡æ³¨"><a href="#å¤‡æ³¨" class="headerlink" title="å¤‡æ³¨"></a>å¤‡æ³¨</h2><p>0.ä»¥ä¸Šæ‰€è¯´javaçš„ç‰ˆæœ¬å‡ä¸ºjava11ï¼Œå®ç°javaæœ¬èº«çš„æºç æ¥è‡ªOpenJdk 11ã€‚</p>
<p>1.OSæ˜¯operater systemï¼Œå³æ“ä½œç³»ç»Ÿçš„ç¼©å†™ã€‚</p>
<p>2.System.cä½äºJavaæºç ç›®å½•ä¸‹çš„java.base&#x2F;share&#x2F;native&#x2F;libjava&#x2F;System.cã€‚</p>
<p>3.æ¢ç©¶javaæ–¹æ³•çš„å®ç°ï¼Œç›®çš„æ˜¯ç†è§£å…¶åŸç†åšåˆ°çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œä½†å¹¶ä¸ä¼šé™·å…¥è¿‡å¤šçš„å®ç°ç»†èŠ‚ï¼Œæ¯”å¦‚c&#x2F;C++é‡Œçš„å®å®šä¹‰ç­‰ã€‚</p>
<p>4.NTPæŒ‡Network Time Protocolï¼Œå³ç½‘ç»œæ—¶é—´åè®®ã€‚</p>
<p><span></span><a href="/">è¿”å›é¦–é¡µ</a><span></span></p></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>
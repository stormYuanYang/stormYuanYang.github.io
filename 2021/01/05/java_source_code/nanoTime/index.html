<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0,  viewport-fit=cover" name="viewport" />
    <meta name="description" content="æ·±å…¥ç†è§£System.nanoTime()" />
    <meta name="hexo-theme-A4" content="v1.6.9" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>çŒ«å’Œå¤©è | å¤ªé˜³å²›</title>

    
        
            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/reset.css">

            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/markdown.css">

            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/fonts.css">
 
            <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
            
        
    
    
<link rel="stylesheet" href="/css/ui.css">
 
    
<link rel="stylesheet" href="/css/style.css">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>
    
    <body>
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    
<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">çŒ«å’Œå¤©è</a> 
            <span class="description">å½“ç„¶æˆ‘åœ¨æ€è€ƒ</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">æ–‡ç« </a></li>
            
        
            
                <li><a href="/categories/">åˆ†ç±»</a></li>
            
        
            
                <li><a href="/tags/">æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/about/">å…³äº</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            æ·±å…¥ç†è§£System.nanoTime()
        </div>
      
    

    <div class="post-md">
        
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#nanotime"><span class="post-toc-text"> nanoTime</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#nanotime%E5%9C%A8linux%E4%B8%8B%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="post-toc-text"> nanoTimeåœ¨Linuxä¸‹çš„å®ç°</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#nanotime%E5%9C%A8windows%E4%B8%8B%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="post-toc-text"> nanoTimeåœ¨Windowsä¸‹çš„å®ç°</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93"><span class="post-toc-text"> æ€»ç»“</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%A4%87%E6%B3%A8"><span class="post-toc-text"> å¤‡æ³¨</span></a></li></ol>
        
        <h2 id="nanotime"><a class="markdownIt-Anchor" href="#nanotime"></a> nanoTime</h2>
<p>å‰å‡ å¤©åˆ†æäº†<code>System.currentTimeMillis()</code>çš„å®ç°ï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹å’Œå®ƒæ¯”è¾ƒç›¸ä¼¼ä½†åˆä¸åŒçš„<code>System.nanoTime()</code>ã€‚<code>System.nanoTime()</code>çš„ç›®çš„æ˜¯ç”¨äº<strong>æµ‹é‡æ—¶é—´çš„å·®å€¼æˆ–è€…è¯´æ—¶é—´çš„æµé€</strong>ï¼š</p>
<pre class="highlight"><code class="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span> &#123;
  <span class="hljs-comment">// do something</span>
&#125;

<span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;
  <span class="hljs-type">long</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> System.nanoTime();
  func();
  <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();
  <span class="hljs-type">long</span> <span class="hljs-variable">diff</span> <span class="hljs-operator">=</span> end - begin;
&#125;
</code></pre>
<p>æ³¨æ„ï¼Œ<code>System.nanoTime()</code>è¿”å›çš„å¹¶ä¸æ˜¯å½“å‰æ—¶é—´ï¼ˆå’Œ<code>System.currentTimeMillis()</code>çš„å«ä¹‰ä¸ä¸€æ ·ï¼‰ï¼Œè€Œæ˜¯<strong>å½“å‰æ—¶åˆ»</strong>åˆ°<strong>ä¸€ä¸ªå›ºå®šä½†æ˜¯å¯ä»¥ä»»æ„çš„æ—¶é—´ç‚¹</strong>çš„å·®å€¼ï¼ˆæ˜¯ä¸æ˜¯æœ‰ç‚¹ç»•ğŸ˜œï¼Œä¸ºäº†è¡¨è¿°çš„ä¸¥è°¨åªèƒ½å¦‚æ­¤)ï¼Œä¹Ÿå°±æ˜¯è¯´è¿”å›å€¼å¯èƒ½æ˜¯æ­£æ•°ä¹Ÿå¯èƒ½æ˜¯è´Ÿæ•°ï¼Œä½†å®é™…ä¸­çš„å®ç°ä¸€èˆ¬æ˜¯å½“å‰æ—¶åˆ»åˆ°è¿‡å»çš„æŸä¸ªæ—¶é—´ç‚¹ï¼ˆæ¯”å¦‚Linuxç”¨çš„ç³»ç»Ÿå¯åŠ¨æ—¶é—´ç‚¹ï¼‰çš„å·®å€¼ï¼›æ‰€ä»¥åªèƒ½ç”¨è‹¥å¹²<code>System.nanoTime()</code>è°ƒç”¨è·å–å…¶å·®å€¼åšä¸€äº›åˆ¤æ–­æˆ–è¿ç®—ï¼Œæ¢è€Œè¨€ä¹‹ä¸€æ¬¡è°ƒç”¨åŸºæœ¬æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼›è€Œä¸”ä¸åŒJavaè™šæ‹Ÿæœºè°ƒç”¨<code>System.nanoTime()</code>ç”¨çš„èµ·å§‹ç‚¹å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒè™šæ‹Ÿæœºä¹‹é—´ä¸èƒ½ç”¨å…¶å€¼æ¥åˆ¤æ–­æ—¶é—´æµé€ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ï¼Œ<code>System.nanoTime()</code>åœ¨Javaä¸­çš„å£°æ˜ï¼š</p>
<pre class="highlight"><code class="java"><span class="hljs-comment">/**
     * Returns the current value of the running Java Virtual Machine&#x27;s
     * high-resolution time source, in nanoseconds.
     *
     * This method can only be used to measure elapsed time and is
     * not related to any other notion of system or wall-clock time.
     * The value returned represents nanoseconds since some fixed but
     * arbitrary &lt;i&gt;origin&lt;/i&gt; time (perhaps in the future, so values
     * may be negative).  The same origin is used by all invocations of
     * this method in an instance of a Java virtual machine; other
     * virtual machine instances are likely to use a different origin.
     *
     * &lt;p&gt;This method provides nanosecond precision, but not necessarily
     * nanosecond resolution (that is, how frequently the value changes)
     * - no guarantees are made except that the resolution is at least as
     * good as that of &#123;<span class="hljs-doctag">@link</span> #currentTimeMillis()&#125;.
     *
     * &lt;p&gt;Differences in successive calls that span greater than
     * approximately 292 years (2&lt;sup&gt;63&lt;/sup&gt; nanoseconds) will not
     * correctly compute elapsed time due to numerical overflow.
     *
     * &lt;p&gt;The values returned by this method become meaningful only when
     * the difference between two such values, obtained within the same
     * instance of a Java virtual machine, is computed.
     *
     * &lt;p&gt;For example, to measure how long some code takes to execute:
     * &lt;pre&gt; &#123;<span class="hljs-doctag">@code</span>
     * long startTime = System.nanoTime();
     * // ... the code being measured ...
     * long elapsedNanos = System.nanoTime() - startTime;&#125;&lt;/pre&gt;
     *
     * &lt;p&gt;To compare elapsed time against a timeout, use &lt;pre&gt; &#123;<span class="hljs-doctag">@code</span>
     * if (System.nanoTime() - startTime &gt;= timeoutNanos) ...&#125;&lt;/pre&gt;
     * instead of &lt;pre&gt; &#123;<span class="hljs-doctag">@code</span>
     * if (System.nanoTime() &gt;= startTime + timeoutNanos) ...&#125;&lt;/pre&gt;
     * because of the possibility of numerical overflow.
     *
     * <span class="hljs-doctag">@return</span> the current value of the running Java Virtual Machine&#x27;s
     *         high-resolution time source, in nanoseconds
     * <span class="hljs-doctag">@since</span> 1.5
     */</span>
    <span class="hljs-meta">@HotSpotIntrinsicCandidate</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-type">long</span> <span class="hljs-title function_">nanoTime</span><span class="hljs-params">()</span>;
</code></pre>
<p>ç”±ä¸Šè¿°å£°æ˜å’Œæ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒJavaæä¾›çš„<code>System.nanoTime()</code>è¿”å›ä»¥çº³ç§’ä¸ºå•ä½çš„é«˜ç²¾åº¦æ—¶é—´ï¼Œä¸è¿‡è¿™å¹¶ä¸æ„å‘³ç€å…¶å‡†ç¡®åº¦å°±æ˜¯1çº³ç§’ã€‚ç‰¹åˆ«æ³¨æ„è¿™è¿™é‡Œï¼š</p>
<blockquote><p>This method can only be used to measure elapsed time and is not related to any other notion of system or wall-clock time.</p>
<footer><strong>Java</strong><cite>System.nanoTime()</cite></footer></blockquote>
<p>å’Œ<code>System.currentTimeMillis()</code>ä¸€æ ·ï¼Œ<code>System.nanoTime()</code>åœ¨è¿™é‡Œåªæœ‰å£°æ˜ï¼Œè€Œæ²¡æœ‰å…·ä½“å®ç°ï¼Œå…¶å®ç°ç”±æ›´åº•å±‚çš„C/C++å®Œæˆã€‚<code>System.nanoTime()</code>å¯¹åº”åˆ°å®ç°æºç åœ¨System.cä¸­ï¼š</p>
<pre class="highlight"><code class="c"><span class="hljs-comment">/* Only register the performance-critical methods */</span><span class="hljs-type">static</span> JNINativeMethod methods[] = &#123;
    &#123;<span class="hljs-string">&quot;currentTimeMillis&quot;</span>, <span class="hljs-string">&quot;()J&quot;</span>,              (<span class="hljs-type">void</span> *)&amp;JVM_CurrentTimeMillis&#125;,
    &#123;<span class="hljs-string">&quot;nanoTime&quot;</span>,          <span class="hljs-string">&quot;()J&quot;</span>,              (<span class="hljs-type">void</span> *)&amp;JVM_NanoTime&#125;,
    &#123;<span class="hljs-string">&quot;arraycopy&quot;</span>,     <span class="hljs-string">&quot;(&quot;</span> OBJ <span class="hljs-string">&quot;I&quot;</span> OBJ <span class="hljs-string">&quot;II)V&quot;</span>, (<span class="hljs-type">void</span> *)&amp;JVM_ArrayCopy&#125;,
&#125;;
</code></pre>
<p>é€šè¿‡å‡½æ•°æŒ‡é’ˆJVM_NanoTimeæ‰¾åˆ°å…¶å¯¹åº”å®ç°ï¼š</p>
<pre class="highlight"><code class="c++"><span class="hljs-built_in">JVM_LEAF</span>(jlong, <span class="hljs-built_in">JVM_NanoTime</span>(JNIEnv *env, jclass ignored))
  <span class="hljs-built_in">JVMWrapper</span>(<span class="hljs-string">&quot;JVM_NanoTime&quot;</span>);
  <span class="hljs-keyword">return</span> os::<span class="hljs-built_in">javaTimeNanos</span>();      
JVM_END
</code></pre>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼ŒJavaå®ç°<code>System.nanoTime()</code>è¿˜æ˜¯ä¾èµ–ä¸åŒOSçš„å®ç°ï¼›æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±çœ‹çœ‹Linuxå’ŒWindowå¹³å°ä¸‹çš„å®ç°ã€‚</p>
<h3 id="nanotimeåœ¨linuxä¸‹çš„å®ç°"><a class="markdownIt-Anchor" href="#nanotimeåœ¨linuxä¸‹çš„å®ç°"></a> nanoTimeåœ¨Linuxä¸‹çš„å®ç°</h3>
<p>æˆ‘ä»¬åœ¨os_linux.cppæ–‡ä»¶ä¸­æ‰¾åˆ°nanoTimeçš„å®ç°:</p>
<pre class="highlight"><code class="c++"><span class="hljs-function">jlong <span class="hljs-title">os::javaTimeNanos</span><span class="hljs-params">()</span> </span>&#123;
  <span class="hljs-comment">// å…ˆæ£€æŸ¥å½“å‰çš„OSæ˜¯å¦æ”¯æŒmonotonic clock</span>
  <span class="hljs-keyword">if</span> (os::<span class="hljs-built_in">supports_monotonic_clock</span>()) &#123;
    <span class="hljs-comment">// æ”¯æŒmonotonic clock</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec</span> tp;
    <span class="hljs-comment">// è°ƒç”¨Linuxå¹³å°ä¸‹çš„clock_gettime()è·å–äº‹ä»¶ä¿¡æ¯</span>
    <span class="hljs-comment">// æ³¨æ„è¿™é‡Œçš„ä¼ å…¥ç±»å‹æ˜¯CLOCK_MONOTONIC</span>
    <span class="hljs-type">int</span> status = Linux::<span class="hljs-built_in">clock_gettime</span>(CLOCK_MONOTONIC, &amp;tp);
    <span class="hljs-built_in">assert</span>(status == <span class="hljs-number">0</span>, <span class="hljs-string">&quot;gettime error&quot;</span>);
    <span class="hljs-comment">// å¯¹clock_gettime()è¿”å›çš„æ—¶é—´ä¿¡æ¯ï¼Œè¿›è¡Œå•ä½è½¬æ¢åè¿”å›</span>
    jlong result = <span class="hljs-built_in">jlong</span>(tp.tv_sec) * (<span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>) + <span class="hljs-built_in">jlong</span>(tp.tv_nsec);
    <span class="hljs-keyword">return</span> result;
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// ä¸æ”¯æŒmonotonic clockï¼Œåˆ™è°ƒç”¨gettimeofday()è·å–æ—¶é—´ä¿¡æ¯</span>
    <span class="hljs-comment">// è¿™éƒ¨åˆ†ä»£ç å’ŒSystem.currentTimeMillis()åœ¨Linuxå¹³å°å®ç°</span>
    <span class="hljs-comment">// å®Œå…¨ä¸€æ ·</span>
    timeval time;
    <span class="hljs-type">int</span> status = <span class="hljs-built_in">gettimeofday</span>(&amp;time, <span class="hljs-literal">NULL</span>);
    <span class="hljs-built_in">assert</span>(status != <span class="hljs-number">-1</span>, <span class="hljs-string">&quot;linux error&quot;</span>);
    jlong usecs = <span class="hljs-built_in">jlong</span>(time.tv_sec) * (<span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>) + <span class="hljs-built_in">jlong</span>(time.tv_usec);
    <span class="hljs-keyword">return</span> <span class="hljs-number">1000</span> * usecs;
  &#125;
&#125;
</code></pre>
<p>é€šè¿‡ä¸Šè¿°ä»£ç å’Œæ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥å¯¹javaTimeNanos()æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œå…¶æœ¬èº«ä¹Ÿä¸å¤æ‚,å…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹å›¾:<img src="/2021/01/05/java_source_code/nanoTime/javaTimeNanos.png" class=""></p>
<p>å¦‚æœå½“å‰Linuxå¹¶ä¸æ”¯æŒmonotonic clock,System.nanoTime()å’ŒSystem.currentTimeMillis()å®é™…ä¸Šå°±æ˜¯ç­‰ä»·çš„,ä½†è¿™ç§æƒ…å†µç›®å‰ä¸€èˆ¬ä¸ä¼šå‡ºç°ï¼Œå¯èƒ½ä¼šå‡ºç°åœ¨ä¸€äº›éå¸¸å¤è€çš„Linuxç‰ˆæœ¬ä¸Šï¼Œå¹¶ä¸”å¦‚æœå½“å‰ç³»ç»Ÿä¸æ”¯æŒmonotonic clock,Javaä¹Ÿç»™å‡ºäº†è­¦å‘Šï¼š</p>
<pre class="highlight"><code class="c++"><span class="hljs-comment">// os_linux.cpp</span>
<span class="hljs-type">void</span> os::Linux::<span class="hljs-built_in">clock_init</span>() &#123;
  <span class="hljs-comment">// we do dlopen&#x27;s in this particular order due to bug in linux</span>
  <span class="hljs-comment">// dynamical loader (see 6348968) leading to crash on exit</span>
  <span class="hljs-type">void</span>* handle = <span class="hljs-built_in">dlopen</span>(<span class="hljs-string">&quot;librt.so.1&quot;</span>, RTLD_LAZY);
  <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">NULL</span>) &#123;
    handle = <span class="hljs-built_in">dlopen</span>(<span class="hljs-string">&quot;librt.so&quot;</span>, RTLD_LAZY);
  &#125;

  <span class="hljs-keyword">if</span> (handle) &#123;
    <span class="hljs-built_in">int</span> (*clock_getres_func)(<span class="hljs-type">clockid_t</span>, <span class="hljs-keyword">struct</span> timespec*) =
           (<span class="hljs-built_in">int</span>(*)(<span class="hljs-type">clockid_t</span>, <span class="hljs-keyword">struct</span> timespec*))<span class="hljs-built_in">dlsym</span>(handle, <span class="hljs-string">&quot;clock_getres&quot;</span>);
    <span class="hljs-built_in">int</span> (*clock_gettime_func)(<span class="hljs-type">clockid_t</span>, <span class="hljs-keyword">struct</span> timespec*) =
           (<span class="hljs-built_in">int</span>(*)(<span class="hljs-type">clockid_t</span>, <span class="hljs-keyword">struct</span> timespec*))<span class="hljs-built_in">dlsym</span>(handle, <span class="hljs-string">&quot;clock_gettime&quot;</span>);
    <span class="hljs-keyword">if</span> (clock_getres_func &amp;&amp; clock_gettime_func) &#123;
      <span class="hljs-comment">// See if monotonic clock is supported by the kernel. Note that some</span>
      <span class="hljs-comment">// early implementations simply return kernel jiffies (updated every</span>
      <span class="hljs-comment">// 1/100 or 1/1000 second). It would be bad to use such a low res clock</span>
      <span class="hljs-comment">// for nano time (though the monotonic property is still nice to have).</span>
      <span class="hljs-comment">// It&#x27;s fixed in newer kernels, however clock_getres() still returns</span>
      <span class="hljs-comment">// 1/HZ. We check if clock_getres() works, but will ignore its reported</span>
      <span class="hljs-comment">// resolution for now. Hopefully as people move to new kernels, this</span>
      <span class="hljs-comment">// won&#x27;t be a problem.</span>
      <span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec</span> res;
      <span class="hljs-keyword">struct</span> <span class="hljs-title class_">timespec</span> tp;
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">clock_getres_func</span> (CLOCK_MONOTONIC, &amp;res) == <span class="hljs-number">0</span> &amp;&amp;
          <span class="hljs-built_in">clock_gettime_func</span>(CLOCK_MONOTONIC, &amp;tp)  == <span class="hljs-number">0</span>) &#123;
        <span class="hljs-comment">// yes, monotonic clock is supported</span>
        _clock_gettime = clock_gettime_func;
        <span class="hljs-keyword">return</span>;
      &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-comment">// close librt if there is no monotonic clock</span>
        <span class="hljs-built_in">dlclose</span>(handle);
      &#125;
    &#125;
  &#125;
  <span class="hljs-built_in">warning</span>(<span class="hljs-string">&quot;No monotonic clock was available - timed services may &quot;</span> \
          <span class="hljs-string">&quot;be adversely affected if the time-of-day clock changes&quot;</span>);
&#125;
</code></pre>
<p>åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šæ£€æµ‹Linuxå†…æ ¸æ˜¯å¦æ”¯æŒ<code>clock_getres</code>å’Œ<code>clock_gettime</code>,å¦‚æœä¸æ”¯æŒ,Javaä¼šç»™å‡ºè­¦å‘Šï¼š</p>
<blockquote><p>No monotonic clock was available - timed services may be adversely affected if the time-of-day clock changes.</p>
<footer><strong>os_linux.cpp</strong><cite>lock_init()</cite></footer></blockquote>
<p>å…³äº<code>clock_getres</code>å’Œ<code>clock_gettime</code>çš„ä»‹ç»è¯·æˆ³<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/clock_gettime.2.html">è¿™é‡Œ</a>ï¼Œç‰¹åˆ«æ³¨æ„é‡Œé¢å…³äºæ—¶é—´ç±»å‹CLOCK_MONOTONICçš„æè¿°ï¼š</p>
<blockquote><p>A nonsettable system-wide clock that represents monotonic time sinceâ€”as described by POSIXâ€”â€œsome unspecified point in the pastâ€.  <strong>On Linux, that point corresponds to the number of seconds that the system has been running since it was booted.</strong></p>
<p>The CLOCK_MONOTONIC clock is not affected by discontinuous jumps in the system time (e.g., if the system administrator manually changes the clock), but is affected by the incremental adjustments performed by adjtime(3) and NTP.  This clock does not count time that the system is suspended.  All CLOCK_MONOTONIC variants guarantee that the time returned by consecutive calls will not go backwards, but successive calls mayâ€”depending on the architectureâ€”return identical (not-increased) time values.</p>
<footer><strong>Linux clock_gettime,</strong><cite><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/clock_gettime.2.html">man7.org/linux/man-pages/man2/clock_gettime.2.html</a></cite></footer></blockquote>
<p>ç”±ä¸Šè¿°å¯çŸ¥ï¼Œä»¥ç±»å‹ClOCK_MONOTONICè·å–æ—¶é—´ä¿¡æ¯æ—¶ï¼š</p>
<ul>
<li>åœ¨Linuxä¸‹å’Œç³»ç»Ÿçš„å¯åŠ¨æ—¶é—´ç‚¹ç›¸å…³ï¼›</li>
<li>æ‰‹åŠ¨ä¿®æ”¹æœ¬åœ°æ—¶é—´ï¼Œå¹¶ä¸ä¼šå½±å“clock_gettime()è·å–çš„clockï¼›ä½†æ˜¯ä¼šå—åˆ°adjtimeå’ŒNTPçš„å½±å“ï¼›</li>
<li>å¹¶ä¸ä¼šè®¡ç®—ç³»ç»Ÿæš‚åœçš„æ—¶é—´æµé€ã€‚</li>
</ul>
<h3 id="nanotimeåœ¨windowsä¸‹çš„å®ç°"><a class="markdownIt-Anchor" href="#nanotimeåœ¨windowsä¸‹çš„å®ç°"></a> nanoTimeåœ¨Windowsä¸‹çš„å®ç°</h3>
<p>åœ¨os_windows.cppä¸­æ‰¾åˆ°javaTimeNanos()çš„å®ç°ï¼š</p>
<pre class="highlight"><code class="c++"><span class="hljs-function">jlong <span class="hljs-title">os::javaTimeNanos</span><span class="hljs-params">()</span> </span>&#123;
    LARGE_INTEGER current_count;
  	<span class="hljs-comment">// Windowsæä¾›çš„å‡½æ•°ï¼šæŸ¥è¯¢å½“å‰çš„è®¡æ•°</span>
    <span class="hljs-built_in">QueryPerformanceCounter</span>(&amp;current_count);
    <span class="hljs-type">double</span> current = <span class="hljs-built_in">as_long</span>(current_count);
    <span class="hljs-comment">// è·å–é¢‘ç‡</span>
    <span class="hljs-type">double</span> freq = performance_frequency;
  	<span class="hljs-comment">// currenté™¤ä»¥freqæ‰æ˜¯å¯¹åº”çš„æ—¶é—´ä¿¡æ¯</span>
    <span class="hljs-comment">// å°†æ—¶é—´ä¿¡æ¯è½¬æ¢æˆçº³ç§’å•ä½</span>
    jlong time = (jlong)((current/freq) * NANOSECS_PER_SEC);
    <span class="hljs-keyword">return</span> time;
&#125;
</code></pre>
<p>ç”±ä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬æ¨æµ‹Windowsè·å–é«˜ç²¾åº¦çš„æ—¶é—´ä¿¡æ¯æ˜¯é€šè¿‡ä¸€ä¸ªå•è°ƒé€’å¢çš„è®¡æ•°å™¨ï¼Œè®¡æ•°å™¨çš„å¢é•¿å°±æ„å‘³ç€æ—¶é—´çš„æµé€ï¼›é‚£ä¹ˆè®¡æ•°å™¨çš„å¢é•¿å¿…ç„¶æ˜¯æœ‰ä¸€ä¸ªé¢‘ç‡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šé•¿æ—¶é—´æ‰§è¡Œä¸€æ¬¡è®¡æ•°å™¨å¢é•¿æ“ä½œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹ï¼š</p>
<pre class="highlight"><code class="c++"><span class="hljs-comment">// os_windows.cpp</span>
<span class="hljs-type">static</span> jlong initial_performance_count;
<span class="hljs-type">static</span> jlong performance_frequency;
<span class="hljs-type">void</span> os::win32::<span class="hljs-built_in">initialize_performance_counter</span>() &#123;
  LARGE_INTEGER count;
  <span class="hljs-comment">// Windowsæä¾›çš„å‡½æ•°ï¼šæŸ¥è¯¢æ›´æ–°è®¡æ•°çš„é¢‘ç‡</span>
  <span class="hljs-built_in">QueryPerformanceFrequency</span>(&amp;count);
  performance_frequency = <span class="hljs-built_in">as_long</span>(count);
  <span class="hljs-comment">// æŸ¥è¯¢å½“å‰çš„è®¡æ•°</span>
  <span class="hljs-built_in">QueryPerformanceCounter</span>(&amp;count);
  <span class="hljs-comment">// è®°å½•èµ·å§‹çš„è®¡æ•°</span>
  initial_performance_count = <span class="hljs-built_in">as_long</span>(count);
&#125;
<span class="hljs-comment">// åˆå§‹åŒ–ç³»ç»Ÿä¿¡æ¯</span>
<span class="hljs-type">void</span> os::win32::<span class="hljs-built_in">initialize_system_info</span>() &#123;
  <span class="hljs-comment">/**
   * ã€‚ã€‚ã€‚ çœç•¥
   */</span>
  <span class="hljs-built_in">initialize_performance_counter</span>();
&#125;
</code></pre>
<p>ä¸Šè¿°åˆå§‹åŒ–æ“ä½œï¼Œå°è¯äº†æˆ‘ä»¬çš„æ¨æµ‹ï¼›è¿™ä¹Ÿæ„å‘³ç€åœ¨Windowså¹³å°ä¸‹QueryPerformanceFrequency()è¿”å›çš„ä¿¡æ¯â€”â€”è¿™ä¸ªé¢‘ç‡å†³å®šäº†æˆ‘ä»¬è·å–æ—¶é—´çš„å‡†ç¡®åº¦ã€‚</p>
<p>Windowså…³äºQueryPerformanceFrequency()çš„è§£é‡Šï¼š</p>
<blockquote><p>Retrieves the frequency of the performance counter. <strong>The frequency of the performance counter is fixed at system boot and is consistent across all processors.</strong> Therefore, the frequency need only be queried upon application initialization, and the result can be cached.</p>
<footer><strong>Windows API,</strong><cite><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency">docs.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency</a></cite></footer></blockquote>
<p>Windowså…³äºQueryPerformanceCounter()çš„è§£é‡Šï¼š</p>
<blockquote><p>Retrieves the current value of the performance counter, which is a high resolution (&lt;1us) time stamp that can be used for time-interval measurements.</p>
<footer><strong>Windows API,</strong><cite><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter">docs.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter</a></cite></footer></blockquote>
<p>æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨Windowså¹³å°ä¸‹ï¼Œè¿™ä¸ªé«˜ç²¾åº¦æ—¶é—´ä¿¡æ¯åŒæ ·å’Œç³»ç»Ÿå¯åŠ¨æ—¶é—´ç›¸å…³ã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>é€šè¿‡æ·±å…¥ç†è§£System.nanoTime()åœ¨Linuxå¹³å°å’ŒWindowså¹³å°çš„ä¸åŒå®ç°ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸è®ºæ˜¯Linuxè¿˜æ˜¯Windowséƒ½æ˜¯é€šè¿‡ç³»ç»Ÿå¯åŠ¨æ—¶é—´ç‚¹æ¥è·å–æˆ‘ä»¬éœ€è¦çš„é«˜ç²¾åº¦å•è°ƒé€’å¢çš„æ—¶é—´ä¿¡æ¯ã€‚é€šè¿‡System.nanoTime()æˆ‘ä»¬è·å–äº†ä»¥çº³ç§’ä¸ºå•ä½çš„é«˜ç²¾åº¦æ—¶é—´ä¿¡æ¯ï¼ˆè®°ä½ï¼Œå…¶å‡†ç¡®åº¦ä¸ä¸€å®šæ˜¯1çº³ç§’ï¼‰ï¼Œä½†åŒæ—¶æˆ‘ä»¬ä¹Ÿä¼šä»˜å‡ºæ›´å¤§çš„æ€§èƒ½ä»£ä»·ï¼ˆæ¯”èµ·System.currentTimeMillis()æ¥è¯´ï¼‰ã€‚æœ€åï¼Œä¹Ÿæœ‰å…¶ä»–æ–¹å¼è·å–ç²¾åº¦æ›´é«˜çš„æ—¶é—´ä¿¡æ¯ï¼ˆCPUæ—¶é’Ÿï¼‰ï¼Œå½“ç„¶æ€§èƒ½ä»£ä»·æ›´å¤§ï¼Œè¿™å°±å¯èƒ½éœ€è¦ä¾èµ–å…·ä½“æŸä¸ªå¹³å°çš„å®ç°äº†ï¼Œè¿™é‡Œåªå…³å¿ƒJavaæºç çš„å®ç°ï¼Œå°±ä¸ç»§ç»­æ·±å…¥æ¢è®¨äº†ã€‚</p>
<h2 id="å¤‡æ³¨"><a class="markdownIt-Anchor" href="#å¤‡æ³¨"></a> å¤‡æ³¨</h2>
<p>0.ä»¥ä¸Šæ‰€è¯´javaçš„ç‰ˆæœ¬å‡ä¸ºjava11ï¼Œå®ç°javaæœ¬èº«çš„æºç æ¥è‡ªOpenJdk 11ã€‚</p>
<p>1.OSæ˜¯operater systemï¼Œå³æ“ä½œç³»ç»Ÿçš„ç¼©å†™ã€‚</p>
<p>2.System.cä½äºJavaæºç ç›®å½•ä¸‹çš„java.base/share/native/libjava/System.cã€‚</p>
<p>3.æ¢ç©¶javaæ–¹æ³•çš„å®ç°ï¼Œç›®çš„æ˜¯ç†è§£å…¶åŸç†åšåˆ°çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œä½†å¹¶ä¸ä¼šé™·å…¥è¿‡å¤šçš„å®ç°ç»†èŠ‚ï¼Œæ¯”å¦‚c/C++é‡Œçš„å®å®šä¹‰ç­‰ã€‚</p>
<p>4.NTPæŒ‡Network Time Protocolï¼Œå³ç½‘ç»œæ—¶é—´åè®®ã€‚</p>

    </div>

    <div class="post-meta">
        <i>
        
            <span>2021-01-05</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« å°æ—‹é£</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/%E6%97%B6%E9%97%B4/'>
                            æ—¶é—´
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E6%BA%90%E7%A0%81/'>
                            æ·±å…¥ç†è§£Javaæºç 
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    
        

     
</div>



                    
                    
                    <div class="footer">
    
        <span> 
            Â© 2019-2023  èœ€ICPå¤‡19006467å· 

            
                

            
        </span>
    
</div>
<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>äººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäººã€‚</span>
            
    
</div>


    
        
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/a11y-dark.min.css">

        
<script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/highlight.min.js"></script>

        
<script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/highlightjs-line-numbers.js"></script>

    


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>
                </div>
            
    </body>
</html>